// Template corrigido - sem problemas de font
async function ensureImageInCache(imageUrl) {
  try {
    console.log('Fazendo fetch da imagem:', imageUrl);
    const response = await fetch(imageUrl);
    console.log('Response status:', response.status);
    
    if (response.ok) {
      const arrayBuffer = await response.arrayBuffer();
      const imageBytes = new Uint8Array(arrayBuffer);
      console.log('Imagem baixada, tamanho:', imageBytes.length, 'bytes');
      
      const image = figma.createImage(imageBytes);
      console.log('✅ Sucesso! Hash:', image.hash);
      return image.hash;
    } else {
      console.log('❌ Resposta não OK:', response.statusText);
    }
  } catch (error) {
    console.log('❌ Erro ao cachear imagem:', error);
  }
  return null;
}

async function main() {
  console.log('=== INICIANDO TESTE FINAL ===');
  
  // URL da sua imagem do GitHub
  const imageUrl = "https://raw.githubusercontent.com/gustavocabraltv/templates-imgs/main/imagem.png";
  
  // Tentar carregar a imagem
  const imageHash = await ensureImageInCache(imageUrl);
  
  // Criar retângulo
  const rectangle = figma.createRectangle();
  figma.currentPage.appendChild(rectangle);
  rectangle.resize(400, 300);
  rectangle.name = "Teste Final";
  rectangle.x = 0;
  rectangle.y = 0;
  
  if (imageHash) {
    console.log('✅ SUCESSO! Aplicando imagem...');
    rectangle.fills = [{
      type: "IMAGE",
      imageHash: imageHash,
      scaleMode: "FILL"
    }];
    
    // Criar retângulo de sucesso (sem texto para evitar problemas de font)
    const successRect = figma.createRectangle();
    figma.currentPage.appendChild(successRect);
    successRect.resize(200, 50);
    successRect.x = 0;
    successRect.y = 320;
    successRect.fills = [{ type: "SOLID", color: { r: 0, g: 0.8, b: 0 } }];
    successRect.name = "✅ IMAGEM CARREGADA!";
    
  } else {
    console.log('❌ FALHA - usando placeholder');
    rectangle.fills = [{ type: "SOLID", color: { r: 0.9, g: 0.2, b: 0.2 } }];
    rectangle.name = "❌ FALHA NO CARREGAMENTO";
  }
  
  console.log('=== TESTE FINALIZADO ===');
}

main();